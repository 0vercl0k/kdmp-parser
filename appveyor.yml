version: 1.0.{build}

image:
  - Visual Studio 2019

configuration:
  - RelWithDebInfo
  - Debug

platform:
  - x86
  - x64

clone_folder: c:\projects\kdmp-parser

before_build:
  - cmd: call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" %platform%
  - cmd: cd build
  - cmd: mkdir %platform%-%configuration%
  - cmd: cmake -DCMAKE_RUNTIME_OUTPUT_DIRECTORY=%APPVEYOR_BUILD_FOLDER%\bin\%platform%-%configuration% -DCMAKE_BUILD_TYPE=%configuration% -GNinja %APPVEYOR_BUILD_FOLDER%

build_script:
  - cmd: cmake --build .

# this happens in the clone_folder
after_build:
  - cmd: if "%platform%"=="x86" if "%configuration%"=="RelWithDebInfo" 7z a -t7z kdmp-parser-x86.release.7z bin\%platform%-%configuration%\*
  - cmd: if "%platform%"=="x86" if "%configuration%"=="Debug" 7z a -t7z kdmp-parser-x86.debug.7z bin\%platform%-%configuration%\*
  - cmd: if "%platform%"=="x64" if "%configuration%"=="RelWithDebInfo" 7z a -t7z kdmp-parser-x64.release.7z bin\%platform%-%configuration%\*
  - cmd: if "%platform%"=="x64" if "%configuration%"=="Debug" 7z a -t7z kdmp-parser-x64.debug.7z bin\%platform%-%configuration%\*
  - cmd: C:\Python38-x64\python.exe run-tests.py
  - cmd: chdir

artifacts:
  - path: kdmp-parser-*.7z

# on_finish:
#   - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
